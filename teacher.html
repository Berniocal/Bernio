<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher QR generator</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --ink:#e5edff; --ink-muted:#9db0d3;
    --edge:#1e293b; --brand:#3b82f6; --brand-2:#60a5fa; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(1200px 800px at 10% -10%,#0f1b35 0%,#0b1220 55%), var(--bg);
    color:var(--ink);
    font:16px/1.45 system-ui,Segoe UI,Roboto,Arial
  }
  .wrap{max-width:980px;margin:22px auto;padding:0 18px}
  .card{
    background:linear-gradient(180deg,var(--card),#0b1326);
    border:1px solid var(--edge);
    border-radius:14px;
    box-shadow:0 18px 60px rgba(0,0,0,.35);
    padding:22px 24px
  }
  h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
  h1::after{content:"";width:10px;height:10px;border-radius:999px;background:#38bdf8;box-shadow:0 0 18px #38bdf8}
  .row{display:flex;flex-wrap:wrap;gap:14px;align-items:flex-end}
  label{color:var(--ink-muted);font-size:14px}

  .input-white{
    background:#ffffff !important;
    color:#111827 !important;
    border:1px solid #cbd5e1 !important;
    border-radius:10px; padding:10px 12px; outline:none;
  }
  #code{min-width:220px;text-transform:uppercase}

  .btn{
    padding:12px 16px;
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:#06101f;border:none;border-radius:10px;font-weight:800;
    cursor:pointer; box-shadow:0 6px 24px rgba(59,130,246,.35)
  }
  .row #gen{
    display:block;
    margin:12px auto 0;
    flex-basis:100%;
    width:100%;
  }

  .qr-wrap{
    margin:26px auto 18px;
    display:block;
    max-width:min(90vw, 480px);
    background:#ffffff;
    border-radius:12px;
    padding:10px;
    border:1px solid #e5e7eb;
  }
  #qrcanvas{
    display:block;
    width:100%; height:auto;
    background:#ffffff; border-radius:6px;
  }

  .used-block{
    margin-top:20px;
    background:#0b1426;border:1px solid var(--edge);
    border-radius:12px;padding:12px
  }
  .hint{color:var(--ink-muted);font-size:13px;margin-bottom:6px}
  .list{background:#0a1324;border:1px solid var(--edge);border-radius:10px;padding:10px 12px;color:#cbd5e1}

  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
         background:#0b1426;border:1px solid var(--edge);color:#e5edff;border-radius:10px;
         padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:none}
  .toast.ok{border-color:rgba(16,185,129,.5)}
  .toast.err{border-color:rgba(239,68,68,.6)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Teacher QR generator</h1>

    <div class="row">
      <div>
        <label for="code">Kód (3 znaky)</label><br>
        <input id="code" maxlength="3" placeholder="A7K" autocomplete="off" class="input-white">
      </div>

      <div>
        <label for="from">Aktivní od (datum + čas)</label><br>
        <input id="from" type="datetime-local" class="input-white">
      </div>

      <div>
        <label for="to">Aktivní do (datum + čas)</label><br>
        <input id="to" type="datetime-local" class="input-white">
      </div>

      <button id="gen" class="btn">Generovat QR</button>
    </div>

    <div class="qr-wrap">
      <canvas id="qrcanvas" width="420" height="420"></canvas>
    </div>

    <div class="used-block">
      <div class="hint">Přihlášení studenti pro kód <b id="curCode">—</b>:</div>
      <div id="roster" class="list">—</div>
    </div>

    <div class="used-block">
      <div class="hint">Vygenerované QR (v ten den nelze znovu stejný 3místný kód):</div>
      <div id="used" class="list">—</div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
/* ==== nastav BASE URL workeru (bez koncového /) ==== */
const API_BASE = "https://examqr.jendabernard.workers.dev";

/* Local storage: jen evidence vygenerovaných kódů (aby učitel omylem nevygeneroval 2× stejný kód v ten den v tom prohlížeči) */
const TEACHER_GEN_KEY = 'bernio.teacher.generated.v2';
const TEACHER_LAST_CODE_KEY = "bern_teacher_last_code_v2";
const MAX_WINDOW_MS = 5 * 60 * 1000;

const $ = (id)=>document.getElementById(id);
const codeEl=$('code'), genBtn=$('gen'), usedEl=$('used'), qrCanvas=$('qrcanvas'), toastEl=$('toast');

function API(p){ return String(API_BASE).replace(/\/+$/,'') + '/' + String(p).replace(/^\/+/, ''); }
function normalizeCode(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,3); }

function showToast(msg, kind='ok'){
  toastEl.textContent = msg;
  toastEl.className = 'toast '+kind;
  toastEl.style.display='block';
  setTimeout(()=>toastEl.style.display='none', 2600);
}

function loadGenerated(){
  try{ return JSON.parse(localStorage.getItem(TEACHER_GEN_KEY) || '{}') || {}; }catch(_){ return {}; }
}
function saveGenerated(map){
  try{ localStorage.setItem(TEACHER_GEN_KEY, JSON.stringify(map||{})); }catch(_){ }
}

function toLocalDayStr(ms){
  const d=new Date(ms);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

async function fetchJSON(url, init={}) {
  const opts = { mode:'cors', cache:'no-store', ...init };
  if (opts.method && opts.method!=='GET' && opts.method!=='HEAD') {
    opts.headers = { ...(opts.headers||{}), 'Content-Type':'application/json' };
  }
  const res = await fetch(url, opts);
  const txt = await res.text();
  let data=null;
  try{ data = txt?JSON.parse(txt):null; }catch{ data={raw:txt}; }
  if(!res.ok){
    const err = (data && (data.error + (data.detail ? (' — '+data.detail) : ''))) || `${res.status} ${res.statusText}`;
    throw new Error(err);
  }
  return data;
}

function drawQR(text){
  return new Promise((resolve,reject)=>{
    QRCode.toCanvas(qrCanvas, String(text), {
      width: qrCanvas.width, margin: 2, errorCorrectionLevel: 'M',
      color: { dark:'#000000', light:'#ffffff' }
    }, (err)=> err?reject(err):resolve());
  });
}

function formatAgo(sec){
  if (sec < 60) return `${sec|0}s`;
  const m = (sec/60)|0, s = sec % 60 | 0;
  return `${m}m ${s}s`;
}

/* ===== GDPR režim: zobrazuj pouze přezdívku a porušení na základě EXPLICITNÍ změny stavu ===== */
function renderRoster(data){
  const cur = $('curCode');
  const box = $('roster');

  cur.textContent = data.code || '—';
  const list = data.participants || [];
  if (!list.length){ box.innerHTML = '—'; return; }

  const now = Math.floor(Date.now()/1000);

  const rows = list.map(p => {
    const sinceAgo = formatAgo(now - (p.since || now));
    const age = now - (p.lastSeen || now);
    const seenAgo  = formatAgo(age);

    const reason = String(p.lastReason || '').toLowerCase();

    // Porušení JE POUZE explicitní stav z klienta:
    // - visible=false (hidden/pagehide)
    // - online=false (offline)
    // - locked=true
    // - violations>0
    // - lastReason v {hidden, pagehide, offline}
    const violated =
      !!p.locked ||
      (p.visible === false) ||
      (p.online === false) ||
      ((p.violations||0) > 0) ||
      (reason === 'hidden' || reason === 'pagehide' || reason === 'offline');

    const flag = violated
      ? '<span style="color:var(--err);font-weight:900">✖</span>'
      : '✅';

    const stateBits = [];
    if (p.locked) stateBits.push('LOCKED');
    if (p.visible === false) stateBits.push('HIDDEN');
    if (p.online === false) stateBits.push('OFFLINE');
    if (reason) stateBits.push(reason.toUpperCase());
    const state = stateBits.join(' · ') || 'OK';

    return `• <b>${escapeHtml(p.name||'')}</b> — od: ${sinceAgo}, naposledy: ${seenAgo} ${flag} <span style="opacity:.8">(${state}${p.violations?`, #${p.violations}`:''})</span>`;
  });

  box.innerHTML = rows.join('<br>');
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

let currentCode = null;
let rosterTimer = 0;

async function pollRoom(){
  if (!currentCode) return;
  try{
    const res = await fetch(`${API('api/room')}/${currentCode}?t=${Date.now()}`, { cache:'no-store' });
    const data = await res.json();
    // data může být error, ale i tak renderRoster čeká ok strukturu; ošetříme:
    if (!data || data.ok === false) return;
    renderRoster(data);
  }catch(_){
    // ignorujeme, další poll za 1s
  }
}

/* ===== Seznam vygenerovaných (lokálně) ===== */
async function refreshUsed(){
  const map = loadGenerated();
  const today = toLocalDayStr(Date.now());
  const dayMap = map[today];
  if (!dayMap || typeof dayMap !== 'object') { usedEl.textContent = '—'; return; }

  const items = Object.keys(dayMap)
    .filter(k => k !== '_last')
    .map(k => dayMap[k])
    .filter(p => p && typeof p === 'object' && p.code);

  if (!items.length) { usedEl.textContent = '—'; return; }

  const fmt = (sec)=> {
    const d=new Date(Number(sec)*1000);
    return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
  };

  items.sort((a,b)=>(a.fromTs||0)-(b.fromTs||0));
  usedEl.textContent = items.map(p=> `${p.code} ${fmt(p.fromTs)}–${fmt(p.toTs)}`).join(' , ');
}

/* ===== Generování QR přes Worker /api/qr ===== */
async function generate(){
  const code = normalizeCode(codeEl.value);
  const fromVal = $('from')?.value || '';
  const toVal   = $('to')?.value || '';

  if (code.length !== 3) { showToast('Zadej přesně 3 alfanumerické znaky (např. A7K).','err'); return; }
  if (!fromVal || !toVal) { showToast('Vyplň od–do (datum i čas).','err'); return; }

  const fromMs = new Date(fromVal).getTime();
  const toMs   = new Date(toVal).getTime();
  if (!isFinite(fromMs) || !isFinite(toMs)) { showToast('Neplatné datum/čas.','err'); return; }
  if (toMs <= fromMs) { showToast('Čas DO musí být po čase OD.','err'); return; }
  if ((toMs - fromMs) > MAX_WINDOW_MS) { showToast('Platnost QR může být maximálně 5 minut.','err'); return; }

  const dayFrom = toLocalDayStr(fromMs);
  const dayTo   = toLocalDayStr(toMs);
  if (dayFrom !== dayTo) { showToast('OD a DO musí být ve stejný den.','err'); return; }

  // Lokální blokace: stejný 3místný kód nesmí být v ten den vygenerovaný 2× (v tomhle prohlížeči)
  const map = loadGenerated();
  map[dayFrom] = map[dayFrom] || {};
  if (map[dayFrom][code]) {
    showToast(`Kód ${code} už byl pro den ${dayFrom} vygenerován.`, 'err');

    // zobraz uložený QR z inner
    try{
      const inner = map[dayFrom][code];
      await drawQR(JSON.stringify({ payload: JSON.stringify(inner) }));
    }catch{}

    currentCode = code;
    $('curCode').textContent = currentCode;
    try{ localStorage.setItem(TEACHER_LAST_CODE_KEY, currentCode); }catch(_){}
    if (rosterTimer) clearInterval(rosterTimer);
    rosterTimer = setInterval(pollRoom, 1000);
    pollRoom();
    refreshUsed();
    return;
  }

  // posíláme okno v sekundách
  const fromSec = Math.floor(fromMs / 1000);
  const toSec   = Math.floor(toMs / 1000);
  const expSec  = Math.max(1, Math.min(300, toSec - fromSec));

  let data;
  try{
    data = await fetchJSON(API('api/qr'), {
      method:'POST',
      body: JSON.stringify({
        type: "START",
        code,
        day: dayFrom,
        fromTs: fromSec,
        toTs: toSec,
        expSec
      })
    });
  }catch(e){
    showToast('API /api/qr selhalo: ' + String(e.message||e), 'err');
    return;
  }

  const inner = data.inner;
  if (!inner || !inner.code) { showToast('Špatná odpověď z /api/qr','err'); return; }

  // ulož pro přehled a reload (jen kódy+okno)
  map[dayFrom][code] = inner;
  map[dayFrom]._last = code;
  saveGenerated(map);

  currentCode = code;
  $('curCode').textContent = currentCode;
  try{ localStorage.setItem(TEACHER_LAST_CODE_KEY, currentCode); }catch(_){}

  // QR vždy obsahuje {payload:"...json..."}
  await drawQR(JSON.stringify({ payload: JSON.stringify(inner) }));
  await refreshUsed();

  showToast(`${code} • aktivní ${dayFrom} ${fromVal.slice(11)}–${toVal.slice(11)}`, 'ok');

  if (rosterTimer) clearInterval(rosterTimer);
  rosterTimer = setInterval(pollRoom, 1000);
  pollRoom();
}

/* ===== Wiring ===== */
codeEl.addEventListener('input', ()=> codeEl.value = normalizeCode(codeEl.value));
genBtn.addEventListener('click', generate);
['keyup','change'].forEach(ev=>{
  codeEl.addEventListener(ev, e=>{ if(e.key==='Enter') genBtn.click(); });
});

/* ===== Init ===== */
(function initDefaults(){
  const now = new Date();
  const pad=(n)=>String(n).padStart(2,'0');
  const toDTLocal=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

  if ($('from') && !$('from').value) $('from').value = toDTLocal(now);
  if ($('to') && !$('to').value){
    const t = new Date(now.getTime()+5*60000);
    $('to').value = toDTLocal(t);
  }

  // obnov poslední použitý dnešní kód (jen pro pohodlí učitele)
  const map = loadGenerated();
  const today = toLocalDayStr(Date.now());
  const dayMap = map[today];
  let last = null;
  try{ last = localStorage.getItem(TEACHER_LAST_CODE_KEY) || null; }catch(_){ last = null; }
  if (!last && dayMap && typeof dayMap === 'object') last = dayMap._last || null;

  const p = (dayMap && typeof dayMap === 'object' && last && dayMap[last]) ? dayMap[last] : null;
  if (p && typeof p === 'object') {
    codeEl.value = p.code;
    $('from').value = toDTLocal(new Date(Number(p.fromTs)*1000));
    $('to').value   = toDTLocal(new Date(Number(p.toTs)*1000));

    drawQR(JSON.stringify({ payload: JSON.stringify(p) })).catch(()=>{});
    currentCode = p.code;
    $('curCode').textContent = currentCode;

    if (rosterTimer) clearInterval(rosterTimer);
    rosterTimer = setInterval(pollRoom, 1000);
    pollRoom();
  }
})();
refreshUsed();
</script>
</body>
</html>

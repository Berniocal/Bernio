<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher QR generator</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0b1220; --bg2:#0d1426; --card:#0f172a; --ink:#e5edff; --ink-muted:#9db0d3;
    --edge:#1e293b; --brand:#3b82f6; --brand-2:#60a5fa; --ok:#10b981; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:radial-gradient(1200px 800px at 10% -10%,#0f1b35 0%,#0b1220 55%), var(--bg);
    color:var(--ink);
    font:16px/1.45 system-ui,Segoe UI,Roboto,Arial
  }
  .wrap{max-width:980px;margin:22px auto;padding:0 18px}
  .card{
    background:linear-gradient(180deg,var(--card),#0b1326);
    border:1px solid var(--edge);
    border-radius:14px;
    box-shadow:0 18px 60px rgba(0,0,0,.35);
    padding:22px 24px
  }
  h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
  h1::after{content:"";width:10px;height:10px;border-radius:999px;background:#38bdf8;box-shadow:0 0 18px #38bdf8}

  /* ovl√°dac√≠ ≈ô√°dek */
  .row{display:flex;flex-wrap:wrap;gap:14px;align-items:flex-end}
  label{color:var(--ink-muted);font-size:14px}

  /* b√≠l√© vstupy pro uƒçitele */
  .input-white{
    background:#ffffff !important;
    color:#111827 !important;
    border:1px solid #cbd5e1 !important;
    border-radius:10px; padding:10px 12px; outline:none;
  }
  #code{min-width:220px;text-transform:uppercase}

  /* tlaƒç√≠tko generovat */
  .btn{
    padding:12px 16px;
    background:linear-gradient(180deg,var(--brand),var(--brand-2));
    color:#06101f;border:none;border-radius:10px;font-weight:800;
    cursor:pointer; box-shadow:0 6px 24px rgba(59,130,246,.35)
  }

  /* tlaƒç√≠tko bude na samostatn√©m ≈ô√°dku a uprost≈ôed */
  .row #gen{
    display:block;
    margin:12px auto 0;   /* auto = vycentrovat */
    flex-basis:100%;      /* zalom na novou ≈ô√°dku v r√°mci .row */
    width:100%;
  }

  /* QR blok vycentrovan√Ω */
  .qr-wrap{
    margin:26px auto 18px;
    display:block;
    max-width:min(90vw, 480px);
    background:#ffffff;          /* b√≠l√© okol√≠ pro tichou z√≥nu QR */
    border-radius:12px;
    padding:10px;
    border:1px solid #e5e7eb;
  }
  #qrcanvas{
    display:block;
    width:100%; height:auto;
    background:#ffffff; border-radius:6px;
  }

  /* seznam pou≈æit√Ωch k√≥d≈Ø */
  .used-block{
    margin-top:20px;
    background:#0b1426;border:1px solid var(--edge);
    border-radius:12px;padding:12px
  }
  .hint{color:var(--ink-muted);font-size:13px;margin-bottom:6px}
  .list{background:#0a1324;border:1px solid var(--edge);border-radius:10px;padding:10px 12px;color:#cbd5e1}

  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);
         background:#0b1426;border:1px solid var(--edge);color:#e5edff;border-radius:10px;
         padding:10px 14px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:none}
  .toast.ok{border-color:rgba(16,185,129,.5)}
  .toast.err{border-color:rgba(239,68,68,.6)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Teacher QR generator</h1>

    <!-- ovl√°d√°n√≠ -->
    <div class="row">
      <div>
        <label for="code">K√≥d (3 znaky)</label><br>
        <input id="code" maxlength="3" placeholder="A7K" autocomplete="off" class="input-white">
      </div>

      <div>
        <label for="from">Aktivn√≠ od (datum + ƒças)</label><br>
        <input id="from" type="datetime-local" class="input-white">
      </div>

      <div>
        <label for="to">Aktivn√≠ do (datum + ƒças)</label><br>
        <input id="to" type="datetime-local" class="input-white">
      </div>

      <button id="gen" class="btn">Generovat QR</button>
    </div>

    <!-- vycentrovan√Ω QR -->
    <div class="qr-wrap">
      <canvas id="qrcanvas" width="420" height="420"></canvas>
    </div>

    <div class="used-block">
      <div class="hint">P≈ôihl√°≈°en√≠ studenti pro k√≥d <b id="curCode">‚Äî</b>:</div>
      <div id="roster" class="list">‚Äî</div>
    </div>

    <!-- seznam pou≈æit√Ωch pod QR -->
    <div class="used-block">
      <div class="hint">Vygenerovan√© QR (jednou na den):</div>
      <div id="used" class="list">‚Äî</div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- QR knihovna -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
/* ==== nastav si BASE URL workeru (bez koncov√©ho /) ==== */
const API_BASE = "https://examqr.jendabernard.workers.dev";

const TEACHER_GEN_KEY = 'bernio.teacher.generated.v1';
const TEACHER_LAST_CODE_KEY = "bern_teacher_last_code_v1";
const MAX_WINDOW_MS = 5 * 60 * 1000; // max 5 minut

function loadGenerated(){
  try{ return JSON.parse(localStorage.getItem(TEACHER_GEN_KEY) || '{}') || {}; }catch(_){ return {}; }
}
function saveGenerated(map){
  try{ localStorage.setItem(TEACHER_GEN_KEY, JSON.stringify(map||{})); }catch(_){ }
}
function toLocalDayStr(ms){
  const d=new Date(ms);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function genToken(){
  const a=new Uint8Array(9);
  (crypto.getRandomValues ? crypto.getRandomValues(a) : a.fill(Math.floor(Math.random()*256)));
  return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('');
}


/* ===== pomocn√© ===== */
const $ = (id)=>document.getElementById(id);
const codeEl=$('code'), genBtn=$('gen'), usedEl=$('used'), qrCanvas=$('qrcanvas'), toastEl=$('toast');

function API(p){ return String(API_BASE).replace(/\/+$/,'') + '/' + String(p).replace(/^\/+/, ''); }
function normalizeCode(s){ return (s||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,3); }
function showToast(msg, kind='ok'){
  toastEl.textContent = msg; toastEl.className = 'toast '+kind;
  toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 2400);
}

/* CORS-safe fetch */
async function fetchJSON(url, init={}) {
  const opts = { mode:'cors', cache:'no-store', ...init };
  if (opts.method && opts.method!=='GET' && opts.method!=='HEAD') {
    opts.headers = { ...(opts.headers||{}), 'Content-Type':'application/json' };
  }
  const res = await fetch(url, opts);
  const txt = await res.text(); let data=null; try{ data = txt?JSON.parse(txt):null; }catch{ data={raw:txt}; }
  if(!res.ok) throw new Error((data&&data.error)||(`${res.status} ${res.statusText}`));
  return data;
}

function drawQR(text){
  return new Promise((resolve,reject)=>{
    QRCode.toCanvas(qrCanvas, String(text), {
      width: qrCanvas.width, margin: 2, errorCorrectionLevel: 'M',
      color: { dark:'#000000', light:'#ffffff' }
    }, (err)=> err?reject(err):resolve());
  });
}

let currentCode = null;
let rosterTimer = 0;

function formatAgo(sec){
  if (sec < 60) return `${sec|0}s`;
  const m = (sec/60)|0, s = sec % 60 | 0;
  return `${m}m ${s}s`;
}

function renderRoster(data){
  const cur = document.getElementById('curCode');
  const box = document.getElementById('roster');
  cur.textContent = data.code || '‚Äî';

  const list = data.participants || [];
  if (!list.length){ box.innerHTML = '‚Äî'; return; }

  const now = Math.floor(Date.now()/1000);
  const rows = list.map(p => {
    const since = formatAgo(now - (p.since || now));
    const age   = now - (p.lastSeen || now);
    const seen  = formatAgo(age);

    const offlineByAge = age > 3;
    const isOnline = p.online && !offlineByAge;

    const violated = (!p.visible) || (String(p.lastReason||'') === 'hidden') || ((p.violations||0) > 0);

    const flag  = (p.locked ? 'üîí'
                  : (violated ? '<span style="color:var(--err);font-weight:900">‚úñ</span>'
                  : (!isOnline ? 'üì¥'
                  : '‚úÖ')));
    const state = [
      p.locked ? 'LOCKED' : '',
      !isOnline ? `OFFLINE${offlineByAge ? ' (bez hl√°≈°en√≠)' : ''}` : '',
      !p.visible ? 'HIDDEN' : ''
    ].filter(Boolean).join(' ¬∑ ') || 'OK';

    return `‚Ä¢ <b>${p.name}</b> ‚Äî od: ${since}, naposledy: ${seen} ${flag} <span style="opacity:.8">(${state}${p.violations?`, #${p.violations}`:''}${p.lastReason?`, ${p.lastReason}`:''})</span>`;
  });

  box.innerHTML = rows.join('<br>');
}

async function pollRoom(){
  if (!currentCode) return;
  try{
    const res = await fetch(`${API_BASE.replace(/\/+$/,'')}/api/room/${currentCode}?t=${Date.now()}`, { cache:'no-store' });
    const data = await res.json();
    renderRoster(data);
  }catch(e){
    // ignoruj, zkus√≠me za 1s znovu
  }
}

/* API akce */
async function refreshUsed(){
  const map = loadGenerated();
  const today = toLocalDayStr(Date.now());
  const day = map[today];
  if (!day || typeof day !== 'object') { usedEl.textContent = '‚Äî'; return; }

  // day je mapa { CODE: payload, _last: "ABC" }
  const items = Object.keys(day)
    .filter(k => k !== '_last')
    .map(k => day[k])
    .filter(p => p && typeof p === 'object' && p.code);
  if (!items.length) { usedEl.textContent = '‚Äî'; return; }

  const fmt = (ts)=>{ const d=new Date(ts); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); };
  // se≈ôaƒè podle startu
  items.sort((a,b)=>(a.fromTs||0)-(b.fromTs||0));
  usedEl.textContent = items.map(p=> `${p.code} ${fmt(p.fromTs)}‚Äì${fmt(p.toTs)}`).join(' , ');
}

async function generate(){
  const code = normalizeCode(codeEl.value);
  const fromVal = document.getElementById('from')?.value || '';
  const toVal   = document.getElementById('to')?.value || '';

  if (code.length !== 3) { showToast('Zadej p≈ôesnƒõ 3 znaky.','err'); return; }
  if (!fromVal || !toVal) { showToast('Vypl≈à od‚Äìdo (datum i ƒças).','err'); return; }

  const fromTsMs = new Date(fromVal).getTime();
  const toTsMs   = new Date(toVal).getTime();

  if (!isFinite(fromTsMs) || !isFinite(toTsMs)) { showToast('Neplatn√© datum/ƒças.','err'); return; }
  if (toTsMs <= fromTsMs) { showToast('ƒåas DO mus√≠ b√Ωt po ƒçase OD.','err'); return; }
  if ((toTsMs - fromTsMs) > MAX_WINDOW_MS) { showToast('Platnost max 5 minut.','err'); return; }

  const dayFrom = toLocalDayStr(fromTsMs);
  const dayTo   = toLocalDayStr(toTsMs);
  if (dayFrom !== dayTo) { showToast('OD a DO mus√≠ b√Ωt ve stejn√Ω den.','err'); return; }

  // lok√°ln√≠ blokace: stejn√Ω 3m√≠stn√Ω k√≥d nesm√≠ v ten den vzniknout 2√ó (v tomto prohl√≠≈æeƒçi)
  const map = loadGenerated();
  map[dayFrom] = map[dayFrom] || {};
  if (map[dayFrom][code]) {
    showToast(`K√≥d ${code} u≈æ byl pro den ${dayFrom} vygenerov√°n.`, 'err');
    currentCode = code;
    document.getElementById('curCode').textContent = currentCode;
    localStorage.setItem(TEACHER_LAST_CODE_KEY, currentCode);

    // vykresli existuj√≠c√≠ QR (z ulo≈æen√© odpovƒõdi workeru)
    try{
      const wrapped = { payload: JSON.stringify(map[dayFrom][code]) };
      await drawQR(JSON.stringify(wrapped));
    }catch{}

    if (rosterTimer) clearInterval(rosterTimer);
    rosterTimer = setInterval(pollRoom, 1000);
    pollRoom();
    refreshUsed();
    return;
  }

  // ===== TADY je KL√çƒå: zavolat worker /api/qr =====
  const fromSec = Math.floor(fromTsMs / 1000);
  const toSec   = Math.floor(toTsMs / 1000);
  const expSec  = Math.max(1, Math.min(300, toSec - fromSec)); // max 5 minut

  let data;
  try{
    data = await fetchJSON(API('api/qr'), {
      method:'POST',
      body: JSON.stringify({
        type: "START",
        code,
        day: dayFrom,       // ulo≈æ√≠ se pod zvolen√Ωm dnem
        fromTs: fromSec,
        toTs: toSec,
        expSec
      })
    });
  }catch(e){
    showToast('API /api/qr selhalo: ' + String(e.message||e), 'err');
    return;
  }

  // worker vrac√≠ inner a wrapped; QR kresl√≠me z wrapped.payload
  const inner = data.inner;
  const wrappedPayload = data.wrapped?.payload;
  if (!inner || !wrappedPayload) { showToast('≈†patn√° odpovƒõƒè z /api/qr','err'); return; }

  // ulo≈æ√≠me si payload lok√°lnƒõ (kv≈Øli p≈ôehledu "vygenerovan√© QR" a reloadu)
  map[dayFrom][code] = inner;      // <‚Äî ukl√°d√°m inner (u≈æ obsahuje fromTs/toTs)
  map[dayFrom]._last = code;
  saveGenerated(map);

  currentCode = code;
  document.getElementById('curCode').textContent = currentCode;
  localStorage.setItem(TEACHER_LAST_CODE_KEY, currentCode);

  await drawQR(JSON.stringify({ payload: wrappedPayload }));
  await refreshUsed();

  showToast(`${code} ‚Ä¢ aktivn√≠ ${dayFrom} ${fromVal.slice(11)}‚Äì${toVal.slice(11)}`, 'ok');

  if (rosterTimer) clearInterval(rosterTimer);
  rosterTimer = setInterval(pollRoom, 1000);
  pollRoom();
}


/* dr√°ty */
codeEl.addEventListener('input', ()=> codeEl.value = normalizeCode(codeEl.value));
genBtn.addEventListener('click', generate);
['keyup','change'].forEach(ev=>{
  codeEl.addEventListener(ev, e=>{ if(e.key==='Enter') genBtn.click(); });
});

/* init */
(function restoreToday(){
  // p≈ôedvypl≈à datum/ƒças (zaokrouhlen√© na minuty)
  const now = new Date();
  const pad=(n)=>String(n).padStart(2,'0');
  const toDTLocal=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const fromEl=document.getElementById('from');
  const toEl=document.getElementById('to');
  if (fromEl && !fromEl.value) fromEl.value = toDTLocal(now);
  if (toEl && !toEl.value){
    const t = new Date(now.getTime()+5*60000);
    toEl.value = toDTLocal(t);
  }

  // kdy≈æ u≈æ dnes existuj√≠ QR, obnov posledn√≠ pou≈æit√© (aby ≈°el po reloadu znovu uk√°zat)
  const map = loadGenerated();
  const today = toLocalDayStr(Date.now());
  const day = map[today];

  let last = null;
  try{ last = localStorage.getItem(TEACHER_LAST_CODE_KEY) || null; }catch(_){ last = null; }
  if (!last && day && typeof day === 'object') last = day._last || null;

  const p = (day && typeof day === 'object' && last && day[last]) ? day[last] : null;
  if (p && typeof p === 'object') {
    codeEl.value = p.code;
    if (fromEl) fromEl.value = toDTLocal(new Date(p.fromTs));
    if (toEl)   toEl.value   = toDTLocal(new Date(p.toTs));
    const wrapped = { payload: JSON.stringify(p) };
    drawQR(JSON.stringify(wrapped)).catch(()=>{});
    currentCode = p.code;
    document.getElementById('curCode').textContent = currentCode;
    if (rosterTimer) clearInterval(rosterTimer);
    rosterTimer = setInterval(pollRoom, 1000);
    pollRoom();
  }
})();
refreshUsed();
</script>
</body>
</html>
